<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>관리자 — 출석부 (강의별 학생명단)</title>
  <style>
    :root{--border:#e6e6e6;--accent:#0275d8}
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;max-width:1100px;margin:16px auto;padding:16px}
    h1{margin:0 0 12px}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;align-items:center}
    select,input[type="text"]{padding:8px;border:1px solid var(--border);border-radius:6px;font-size:14px}
    button{padding:8px 12px;border-radius:6px;border:0;background:var(--accent);color:#fff;cursor:pointer}
    button.ghost{background:#f5f5f5;color:#000;border:1px solid #ddd}
    .panel{border:1px solid var(--border);padding:12px;border-radius:8px;background:#fff}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{border:1px solid var(--border);padding:8px;text-align:left;font-size:13px}
    th{background:#f7f7f7}
    .muted{color:#666;font-size:13px}
    .info{font-size:13px;margin-bottom:8px}
    .actions{display:flex;gap:8px;margin-top:8px}
    .loading{color:#666;font-style:italic}
    @media (max-width:880px){
      .controls{flex-direction:column;align-items:stretch}
    }
  </style>
</head>
<body>
  <h1>관리자 — 출석부 (강의별 학생명단)</h1>
  <div class="info muted">날짜, 교시(또는 블록), 강의(또는 강의실/활동)를 선택하면 해당 수업에 신청한 학생 명단을 불러옵니다. CSV로 내보내기 가능.</div>

  <div class="panel">
    <div class="controls">
      <label>
        날짜
        <select id="selDate"></select>
      </label>

      <label>
        교시
        <select id="selPeriod">
          <option value="1">1교시</option>
          <option value="2">2교시</option>
          <option value="3">3교시</option>
          <option value="4">4교시</option>
          <option value="5">5교시</option>
          <option value="6">6교시</option>
          <option value="1-2">1-2교시 (블록)</option>
          <option value="3-4">3-4교시 (블록)</option>
        </select>
      </label>

      <label style="flex:1">
        강의 / 활동 (강의실)
        <select id="selOffering" style="width:100%"><option>먼저 날짜와 교시를 선택하세요</option></select>
      </label>

      <button id="btnLoad">명단 불러오기</button>
      <button id="btnExport" class="ghost">CSV 내보내기</button>
    </div>

    <div id="status" class="muted"></div>

    <div id="resultArea" style="margin-top:12px">
      <div id="attendanceInfo" class="info"></div>
      <div id="attendanceTableWrap"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Supabase 설정 (index-2/index-3과 동일한 값 사용)
    const SUPABASE_URL = 'https://metdfyhhcvvjmkkwyvcf.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1ldGRmeWhoY3Z2am1ra3d5dmNmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5OTQzOTUsImV4cCI6MjA4MDU3MDM5NX0.vcC6tjeYU9CQlC92jJOKgcf3cR0t36g5J19pk2uQrDs';
    const { createClient } = window.supabase;
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // 날짜 상수 (index-2 / index-3과 동일)
    const DAYS = ["1/26(월)","1/27(화)","1/28(수)","1/29(목)","1/30(금)","2/2(월)","2/3(화)","2/4(수)","2/5(목)","2/6(금)"];
    const PERIODS = [1,2,3,4,5,6];

    // 캐시: course_capacity 전체(관리자용 인덱스)
    let courseCapacities = [];

    // --- Helpers: normalization to avoid mobile Safari mismatch issues ---
    // Mobile Safari sometimes returns values that differ in spacing / unicode parens etc.
    // Normalize both the selDate.value and parsed offering.day before comparing.
    function normalizeDayKey(s) {
      if (s === null || s === undefined) return '';
      return String(s)
        .trim()
        // convert fullwidth parentheses to ascii
        .replace(/[\uFF08\uFF09（）]/g, c => (c === '（' ? '(' : (c === '）' ? ')' : c)))
        // normalize multiple spaces
        .replace(/\s+/g, ' ')
        // normalize slash spacing
        .replace(/\s*\/\s*/g, '/')
        // normalize different hyphen chars to ascii hyphen
        .replace(/[\u2010\u2011\u2012\u2013\u2014]/g, '-')
        .toLowerCase();
    }

    // escape helper (function declaration hoisted)
    function escapeHtml(s){ if (s===null||s===undefined) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }

    // 초기화: 날짜 드롭다운 채우기, course_capacity 로드
    async function init(){
      const selDate = document.getElementById('selDate');
      // Use normalized key as option value to avoid subtle mismatch on mobile browsers
      selDate.innerHTML = DAYS.map(d => `<option value="${escapeHtml(normalizeDayKey(d))}">${escapeHtml(d)}</option>`).join('');
      // load course_capacity records
      await loadCourseCapacities();
      // wire events
      document.getElementById('selDate').addEventListener('change', () => debounceUpdateOfferingList());
      document.getElementById('selPeriod').addEventListener('change', () => debounceUpdateOfferingList());
      document.getElementById('btnLoad').addEventListener('click', loadAttendanceList);
      document.getElementById('btnExport').addEventListener('click', exportCsvOfCurrent);
      // initial fill
      updateOfferingList();
      setStatus('준비 완료');
    }

    function setStatus(msg, loading=false){
      const s = document.getElementById('status');
      s.textContent = msg || '';
      s.className = loading ? 'loading' : 'muted';
    }

    // load all course_capacity rows to courseCapacities array
    async function loadCourseCapacities(){
      try {
        setStatus('course_capacity 로딩 중...', true);
        const { data, error } = await supabase.from('course_capacity').select('*');
        if (error) throw error;
        courseCapacities = data || [];
        setStatus('course_capacity 로드 완료. 옵션 구성 중...');
      } catch (err) {
        console.error(err);
        setStatus('course_capacity 로드 실패 — 강의/강의실 옵션은 course_capacity.id 기반으로 생성됩니다.');
        courseCapacities = [];
      }
    }

    // parse course_capacity.id (또는 id-like string) 에서 의미있는 메타(날짜, periods, label)를 추출
    // 결과: { id, day: "1/27(화)" or '', periods: [1] or [1,2], label: '영화 1-2교시' }
    function parseCourseCapacityId(id){
      if (!id || typeof id !== 'string') return null;
      const orig = id;
      // select_0127_<subject> -> day 1/27(화) -> period 5 (except 0202 -> 4)
      if (/^select_(\d{4})_/i.test(id)){
        const m = id.match(/^select_(\d{4})_(.+)$/i);
        const code = m[1];
        const subj = (m[2] || '').replace(/_/g,' ');
        const map = { '0126':'1/26(월)','0127':'1/27(화)','0128':'1/28(수)','0129':'1/29(목)','0202':'2/2(월)' };
        const day = map[code] || code;
        const period = (code === '0202') ? 4 : 5;
        return { id: orig, day, periods: [period], label: `선택수업 (${subj})` };
      }

      // 책 읽기 formats
      let m = id.match(/책\s*읽기[_ ](.+?)_(\d+)교시_(.+)/i) || id.match(/책읽기[_ ](.+?)_(\d+)교시_(.+)/i);
      if (m){
        const day = m[1];
        const p = Number(m[2]);
        const subj = m[3].replace(/_/g,' ');
        return { id: orig, day, periods: [p], label: `책읽기 (${subj})` };
      }

      // movie_1/27(화)_1-2교시 or movie_1/27(화)_1
      m = id.match(/^(?:movie|영화)_(.+?)_(\d+(?:-\d+)?)(?:교시)?/i);
      if (m){
        const day = m[1];
        const blk = m[2];
        if (blk.includes('-')){
          const [a,b] = blk.split('-').map(x=>Number(x));
          return { id: orig, day, periods: [a,b], label: `영화 (${a}-${b}교시)` };
        } else {
          const a = Number(blk);
          return { id: orig, day, periods: [a, a+1], label: `영화 (${a}-${a+1}교시)` };
        }
      }

      // 마네_2/2(월)_3교시
      m = id.match(/마네_(.+?)_(\d+)교시/i) || id.match(/마네_(.+?)_(\d+)/i);
      if (m){
        const day = m[1];
        const p = Number(m[2]);
        return { id: orig, day, periods: [p], label: `마네 (${p}교시)` };
      }

      // bible formats: bible_2/2(월)_1교시 or 성경동화_...
      m = id.match(/(?:bible|성경동화)_(.+?)_(\d+)교시/i) || id.match(/(?:bible|성경동화)_(.+?)_(\d+)/i);
      if (m){
        const day = m[1];
        const p = Number(m[2]);
        return { id: orig, day, periods: [p], label: `성경동화 (${p}교시)` };
      }

      // fallback: try detect date token
      m = id.match(/(1\/26\(월\)|1\/27\(화\)|1\/28\(수\)|1\/29\(목\)|1\/30\(금\)|2\/2\(월\)|2\/3\(화\)|2\/4\(수\)|2\/5\(목\)|2\/6\(금\))/);
      if (m){
        const day = m[1];
        const p2 = id.match(/(\d)교시/) || id.match(/_(\d)_/);
        const p = p2 ? Number(p2[1]) : null;
        return { id: orig, day, periods: p ? [p] : [], label: id };
      }

      // final fallback: return id as label with no day/period
      return { id: orig, day: '', periods: [], label: id };
    }

    // build index of parsed offerings from courseCapacities
    function buildOfferingsIndex(){
      const offerings = [];
      for (const r of courseCapacities){
        const parsed = parseCourseCapacityId(String(r.id || r.course_capacity_id || r.course_id || ''));
        const labelFromMeta = (r.name || r.course_name || r.title || '').trim();
        if (parsed){
          if (labelFromMeta) parsed.label = `${labelFromMeta} (${parsed.label})`;
          // add normalized key for reliable matching (mobile browsers)
          parsed.dayKey = normalizeDayKey(parsed.day || '');
          offerings.push(Object.assign({}, parsed, { raw: r }));
        } else {
          const fallback = { id: String(r.id||r.course_capacity_id||''), day:'', dayKey:'', periods:[], label: String(r.name||r.id||r.course_capacity_id||'') };
          offerings.push(fallback);
        }
      }
      return offerings;
    }

    // current offerings index
    let offeringsIndex = [];

    // Debounce helper to avoid rapid changes that can confuse mobile pickers
    let updateTimeout = null;
    function debounceUpdateOfferingList(delay = 120){
      if (updateTimeout) clearTimeout(updateTimeout);
      updateTimeout = setTimeout(() => { updateOfferingList(); updateTimeout = null; }, delay);
    }

    // update offering select based on selected date and period
    function updateOfferingList(){
      if (!courseCapacities || courseCapacities.length === 0) {
        offeringsIndex = buildOfferingsIndex();
      } else {
        offeringsIndex = buildOfferingsIndex();
      }
      const selDateEl = document.getElementById('selDate');
      const dateKey = selDateEl.value; // normalized key stored at init
      const periodSel = document.getElementById('selPeriod').value;
      const sel = document.getElementById('selOffering');
      sel.innerHTML = '';

      const matches = offeringsIndex.filter(o => {
        // offerings without a detected day are still considered (but below we require day match)
        if (!o || !o.dayKey) return false;
        if (!dateKey) return false;
        if (o.dayKey !== dateKey) return false;
        if (!o.periods || o.periods.length === 0) return true; // include if no period info
        // handle block selection
        if (periodSel === '1-2' || periodSel === '3-4'){
          const [a,b] = periodSel.split('-').map(x=>Number(x));
          // require offering to contain both periods
          return o.periods.length >= 2 && o.periods[0] === a && o.periods[1] === b;
        } else {
          const p = Number(periodSel);
          return o.periods.includes(p);
        }
      });

      if (matches.length === 0){
        sel.innerHTML = `<option value="">해당 날짜/교시에 매칭되는 강의가 없습니다</option>`;
        setStatus('옵션 없음');
        return;
      }
      // unique by id
      const seen = new Set();
      const opts = matches.map(o=>{
        if (seen.has(o.id)) return null;
        seen.add(o.id);
        const label = o.label || o.id;
        // use original id as option value (not the normalized day key) because registrations use that id
        return `<option value="${escapeHtml(o.id)}">${escapeHtml(label)}</option>`;
      }).filter(Boolean).join('');
      sel.innerHTML = opts;
      setStatus(`${matches.length}개 강의 옵션 로드됨`);
    }

    // load attendance list for selected offering (registrations -> students)
    async function loadAttendanceList(){
      const offeringId = document.getElementById('selOffering').value;
      if (!offeringId){
        alert('강의를 선택하세요.');
        return;
      }
      setStatus('명단 불러오는 중...', true);
      document.getElementById('attendanceTableWrap').innerHTML = '';
      document.getElementById('attendanceInfo').textContent = '';
      try {
        // fetch registrations for this course_capacity_id
        const { data: regs, error: regErr } = await supabase.from('registrations').select('registration_id,student_id').eq('course_capacity_id', offeringId);
        if (regErr) throw regErr;
        if (!regs || regs.length === 0){
          document.getElementById('attendanceInfo').textContent = '신청한 학생이 없습니다.';
          setStatus('조회 완료: 0명');
          return;
        }
        const studentIds = regs.map(r=>r.student_id);
        // fetch students
        const { data: students, error: stuErr } = await supabase.from('students').select('student_id,class,name').in('student_id', studentIds);
        if (stuErr) throw stuErr;
        // build map
        const byId = {};
        for (const s of students) byId[s.student_id] = s;
        // order regs by student name/class for nicer display
        const rows = regs.map(r => {
          const s = byId[r.student_id] || { student_id: r.student_id, class:'', name:''};
          return { registration_id: r.registration_id, student_id: r.student_id, class: s.class||'', name: s.name||'' };
        }).sort((a,b) => {
          if (a.class===b.class) return (''+a.name).localeCompare(b.name);
          return (''+a.class).localeCompare(b.class);
        });

        // render table
        let html = '<table><thead><tr><th>#</th><th>student_id</th><th>반(class)</th><th>이름</th><th>registration_id</th></tr></thead><tbody>';
        rows.forEach((r,i)=> html += `<tr><td>${i+1}</td><td>${escapeHtml(r.student_id)}</td><td>${escapeHtml(r.class)}</td><td>${escapeHtml(r.name)}</td><td>${escapeHtml(r.registration_id)}</td></tr>`);
        html += '</tbody></table>';
        document.getElementById('attendanceTableWrap').innerHTML = html;
        // use the selected option's text for a friendly date label
        const metaLabel = document.getElementById('selOffering').selectedOptions[0]?.textContent || '';
        document.getElementById('attendanceInfo').textContent = `총 ${rows.length}명 (course_capacity_id: ${offeringId})`;
        // store latest for CSV export (use the displayed date text for filename)
        window.__lastAttendanceRows = rows;
        window.__lastAttendanceMeta = {
          offeringId,
          dateDisplay: document.getElementById('selDate').selectedOptions[0]?.textContent || '',
          period: document.getElementById('selPeriod').value,
          label: metaLabel
        };
        setStatus(`조회 완료: ${rows.length}명`);
      } catch (err) {
        console.error(err);
        setStatus('조회 실패');
        document.getElementById('attendanceTableWrap').innerHTML = `<div class="muted">조회 실패: ${escapeHtml(err.message || err)}</div>`;
      }
    }

    // CSV export of currently loaded attendance
    function exportCsvOfCurrent(){
      const rows = window.__lastAttendanceRows || [];
      const meta = window.__lastAttendanceMeta || {};
      if (!rows || rows.length === 0) {
        alert('내보낼 출석 데이터가 없습니다. 먼저 명단을 불러오세요.');
        return;
      }
      const header = ['index','student_id','class','name','registration_id'];
      const csvRows = [header];
      rows.forEach((r,i)=> csvRows.push([i+1, r.student_id, r.class, r.name, r.registration_id]));
      const datePart = (meta.dateDisplay || '').replace(/\s+/g,'_').replace(/[^\w\-()]/g,'');
      const labelPart = (meta.label||meta.offeringId||'unnamed').replace(/\s+/g,'_').replace(/[^\w\-()]/g,'');
      const filename = `attendance_${datePart}_${labelPart}_${new Date().toISOString().slice(0,10)}.csv`;
      downloadCsv(csvRows, filename);
    }

    function downloadCsv(rows, filename){
      const csv = rows.map(r => r.map(c => `"${String(c||'').replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename || 'attendance.csv';
      document.body.appendChild(a); a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // kick off
    init();
  </script>
</body>
</html>
